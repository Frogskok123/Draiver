name: Build GKI Kernel Module (No Vermagic)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - kernel_version: "5.10"
            android_branch: "android12-5.10"
            ndk_version: "r25c"
            ndk_url: "https://dl.google.com/android/repository/android-ndk-r25c-linux.zip"
            artifact_name: "jiangnight-5.10.ko"
          
          - kernel_version: "6.1"
            android_branch: "android14-6.1"
            ndk_version: "r27"
            ndk_url: "https://dl.google.com/android/repository/android-ndk-r27-linux.zip"
            artifact_name: "jiangnight-6.1.ko"
    
    steps:
    - name: Checkout driver source
      uses: actions/checkout@v4
      with:
        path: driver-src

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev \
                                python3 python3-pip git wget lld llvm \
                                gcc-aarch64-linux-gnu pahole dwarves

    - name: Setup Android NDK
      run: |
        wget -q ${{ matrix.ndk_url }}
        unzip -q android-ndk-${{ matrix.ndk_version }}-linux.zip
        echo "$GITHUB_WORKSPACE/android-ndk-${{ matrix.ndk_version }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Clone GKI kernel
      run: |
        git clone --depth 1 --branch ${{ matrix.android_branch }} https://android.googlesource.com/kernel/common gki-kernel

    - name: Integrate driver into kernel tree
      run: |
        cd gki-kernel
        mkdir -p drivers/khack
        cp $GITHUB_WORKSPACE/driver-src/kernel/* drivers/khack/ || cp $GITHUB_WORKSPACE/driver-src/* drivers/khack/
        
        cat > drivers/khack/Kconfig <<-'EOF'
        config KERNEL_HACK
            tristate "JiangNight Memory Hack Driver"
            default m
        EOF
        
        cat > drivers/khack/Makefile <<-'EOF'
        obj-$(CONFIG_KERNEL_HACK) += jiangnight.o
        jiangnight-objs := entry.o 
        ccflags-y := -Wno-declaration-after-statement -Wno-unused-function -fno-stack-protector
        EOF
        
        echo 'source "drivers/khack/Kconfig"' >> drivers/Kconfig
        echo 'obj-$(CONFIG_KERNEL_HACK) += khack/' >> drivers/Makefile

    - name: Configure and Build
      env:
        ARCH: arm64
        LLVM: 1
        LLVM_IAS: 1
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        cd gki-kernel
        
        make O=out mrproper
        make O=out gki_defconfig
        
        # --- Максимальное отключение защит ---
        ./scripts/config --file out/.config --disable CONFIG_CC_STACKPROTECTOR_STRONG
        ./scripts/config --file out/.config --enable CONFIG_CC_STACKPROTECTOR_NONE
        ./scripts/config --file out/.config --disable CONFIG_MODVERSIONS
        ./scripts/config --file out/.config --enable CONFIG_MODULE_FORCE_LOAD
        
        echo "CONFIG_KERNEL_HACK=m" >> out/.config
        
        if [[ "${{ matrix.kernel_version }}" == "6.1" ]]; then
          echo "CONFIG_DEBUG_INFO_BTF=n" >> out/.config
          echo "CONFIG_MODULE_ALLOW_BTF_MISMATCH=y" >> out/.config
        fi
        
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS olddefconfig
        
        # --- ХАК: Пытаемся сделать версию пустой при сборке ---
        # Очищаем .scmversion и пытаемся обмануть скрипты
        echo "" > .scmversion
        touch .scmversion
        
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS -j$(nproc) modules_prepare
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS -j$(nproc) M=drivers/khack
        
        # --- ХАК 2: Бинарное удаление vermagic из .ko ---
        # Мы находим строку "vermagic=" и заменяем её на нули.
        # Это опасный метод, но если insmod -f нет, это единственный шанс
        # Работает так: ищем смещение "vermagic=", и затираем данные после него
        
        cd out/drivers/khack
        
        # Этот python-скрипт найдет секцию .modinfo и заменит vermagic на пустую строку (или занулит)
        python3 -c '
        import sys
        
        def patch_vermagic(filename):
            with open(filename, "rb") as f:
                data = bytearray(f.read())
            
            # Ищем маркер vermagic=
            # В ядре 5.10/6.1 он обычно выглядит как "vermagic=X.Y.Z..."
            marker = b"vermagic="
            start = data.find(marker)
            
            if start == -1:
                print(f"Vermagic marker not found in {filename}")
                return
            
            print(f"Found vermagic at offset {start}")
            
            # Находим конец строки (null-byte)
            end = data.find(b"", start)
            if end == -1:
                end = len(data)
            
            # Затираем версию: оставляем "vermagic=" но версию делаем пустой или нулями
            # Вариант 1: Оставить "vermagic=" (пустая версия)
            # data[start + len(marker)] = 0
            
            # Вариант 2 (Агрессивный): Забить всю строку нулями
            for i in range(start, end):
                data[i] = 0
                
            with open(filename, "wb") as f:
                f.write(data)
            print("Vermagic wiped!")

        patch_vermagic("jiangnight.ko")
        '

    - name: Upload module
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: gki-kernel/out/**/jiangnight.ko
        if-no-files-found: error
