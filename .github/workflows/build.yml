name: Build GKI Kernel Modules

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - kernel_version: "5.10"
            android_branch: "android12-5.10"
            ndk_version: "r25c"
            ndk_url: "https://dl.google.com/android/repository/android-ndk-r25c-linux.zip"
            artifact_name: "jiangnight-5.10.ko"
          
          - kernel_version: "6.1"
            android_branch: "android14-6.1"
            ndk_version: "r26b"
            ndk_url: "https://dl.google.com/android/repository/android-ndk-r26b-linux.zip"
            artifact_name: "jiangnight-6.1.ko"

    steps:
    - name: Checkout driver source
      uses: actions/checkout@v4
      with:
        path: driver-src

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev \
                                python3 python3-pip git wget lld llvm \
                                gcc-aarch64-linux-gnu

    - name: Setup Android NDK (${{ matrix.ndk_version }})
      run: |
        wget -q ${{ matrix.ndk_url }}
        unzip -q android-ndk-${{ matrix.ndk_version }}-linux.zip
        echo "$GITHUB_WORKSPACE/android-ndk-${{ matrix.ndk_version }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Clone GKI kernel (${{ matrix.kernel_version }})
      run: |
        git clone --depth 1 --branch ${{ matrix.android_branch }} https://android.googlesource.com/kernel/common gki-kernel

    - name: Integrate driver into kernel tree
      run: |
        cd gki-kernel
        mkdir -p drivers/khack
        
        # Копируем .c и .h из корня driver-src в drivers/khack
        cp $GITHUB_WORKSPACE/driver-src/*.c drivers/khack/ || true
        cp $GITHUB_WORKSPACE/driver-src/*.h drivers/khack/ || true
        
        cat > drivers/khack/Kconfig <<-'EOF'
        config KERNEL_HACK
            tristate "JiangNight Memory Hack Driver"
            default m
        EOF
        
        cat > drivers/khack/Makefile <<-'EOF'
        obj-$(CONFIG_KERNEL_HACK) += jiangnight.o
        jiangnight-objs := entry.o
        ccflags-y := -Wno-declaration-after-statement -Wno-unused-function
        EOF
        
        echo 'source "drivers/khack/Kconfig"' >> drivers/Kconfig
        echo 'obj-$(CONFIG_KERNEL_HACK) += khack/' >> drivers/Makefile

    - name: Configure and Build (${{ matrix.kernel_version }})
      working-directory: gki-kernel
      env:
        ARCH: arm64
        LLVM: 1
        LLVM_IAS: 1
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        # 1. Конфигурация
        make O=out mrproper
        make O=out gki_defconfig
        
        # 2. Включение модуля
        ./scripts/config --file out/.config --enable CONFIG_KERNEL_HACK
        make O=out olddefconfig
        
        # 3. Подготовка
        make O=out -j$(nproc) modules_prepare
        
        # 4. Сборка
        # Важно: При сборке с O=out, объектные файлы могут оказаться глубоко в структуре out
        make O=out -j$(nproc) M=drivers/khack modules

    - name: Upload module (${{ matrix.kernel_version }})
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        # ВОССТАНОВЛЕНО: Используем ** для рекурсивного поиска jiangnight.ko в папке out
        # Это найдет файл, где бы он ни лежал (out/drivers/khack/ или глубже)
        path: gki-kernel/out/**/jiangnight.ko
        if-no-files-found: error
