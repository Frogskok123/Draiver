name: Build GKI Modules (External)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-matrix:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - kernel_version: "5.4"
            android_version: "11"
            branch: "android11-5.4"
            ndk_version: "r23c"
            
          - kernel_version: "5.10"
            android_version: "12"
            branch: "android12-5.10"
            ndk_version: "r25c"
            
          - kernel_version: "5.15"
            android_version: "13"
            branch: "android13-5.15"
            ndk_version: "r26d"
            
          - kernel_version: "6.1"
            android_version: "14"
            branch: "android14-6.1"
            ndk_version: "r27"
            
          - kernel_version: "6.6"
            android_version: "15"
            branch: "android15-6.6"
            ndk_version: "r27"

    name: Build Kernel ${{ matrix.kernel_version }}
    
    steps:
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        df -h

    - name: Checkout Driver
      uses: actions/checkout@v4
      with:
        path: driver-src

    - name: Install Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq build-essential bc bison flex libssl-dev libelf-dev lld llvm git wget dwarves

    - name: Setup NDK
      id: setup-ndk
      run: |
        if [ ! -d "android-ndk-${{ matrix.ndk_version }}" ]; then
          wget -q https://dl.google.com/android/repository/android-ndk-${{ matrix.ndk_version }}-linux.zip
          unzip -q android-ndk-${{ matrix.ndk_version }}-linux.zip
        fi
        echo "$GITHUB_WORKSPACE/android-ndk-${{ matrix.ndk_version }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Clone Kernel
      timeout-minutes: 30
      run: |
        git clone --depth 1 --branch ${{ matrix.branch }} --filter=blob:none https://android.googlesource.com/kernel/common gki-kernel

    - name: Prepare Driver Makefile
      run: |
        cd driver-src
        # Создаем Makefile для OOT сборки
        cat > Makefile << 'EOF'
        obj-m += jiangnight.o
        jiangnight-objs := entry.o
        
        # Flags
        ccflags-y := -Wno-error=implicit-function-declaration
        ccflags-y += -Wno-error=incompatible-pointer-types
        ccflags-y += -Wno-error=int-conversion
        ccflags-y += -fno-sanitize=cfi
        ccflags-y += -fno-sanitize=cfi-icall
        
        all:
        \tmake -C $(KERNEL_SRC) M=$(PWD) modules
        
        clean:
        \tmake -C $(KERNEL_SRC) M=$(PWD) clean
        EOF

    - name: Configure Kernel
      working-directory: gki-kernel
      env:
        ARCH: arm64
        LLVM: 1
        LLVM_IAS: 1
      run: |
        # Используем V=1 для подробного лога ошибок
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS gki_defconfig
        
        # Важно: для External Modules не нужно править .config ядра!
        # Достаточно подготовить modules_prepare
        
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS modules_prepare

    - name: Build Module
      working-directory: gki-kernel
      env:
        ARCH: arm64
        LLVM: 1
        LLVM_IAS: 1
      run: |
        # Запускаем сборку, указывая путь к исходникам драйвера
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS \
          M=$GITHUB_WORKSPACE/driver-src \
          modules

    - name: Verify Artifacts
      run: |
        MODULE_PATH=$(find driver-src -name "*.ko" -type f | head -n1)
        if [ -z "$MODULE_PATH" ]; then
          echo "❌ Build failed - .ko file not found"
          exit 1
        fi
        echo "✅ Built: $MODULE_PATH"
        
        mkdir -p artifacts
        cp "$MODULE_PATH" artifacts/jiangnight-${{ matrix.kernel_version }}.ko

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: jiangnight-${{ matrix.kernel_version }}
        path: artifacts/*.ko
        compression-level: 9

  create-release:
    needs: build-matrix
    runs-on: ubuntu-22.04
    if: success()
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: modules
      
      - name: Package
        run: |
          mkdir release
          find modules -name "*.ko" -exec cp {} release/ ;
          ls -lh release/
          
      - uses: actions/upload-artifact@v4
        with:
          name: all-modules
          path: release/
